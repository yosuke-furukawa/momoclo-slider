// Generated by CoffeeScript 1.3.1
(function() {
  var Slide, Slider;
  function getFigtag(jsonData) {
      if(jsonData.category == 'twitpic') {
      return "<figure><a href=http://twitpic.com/" + jsonData.short_id + " ><img src=" + "http://twitpic.com/show/full/" + jsonData.short_id +
          " width=" + jsonData.width + "px height=" + jsonData.height + "px /></a>" +
          "<figcaption>" +
          "<h2>" + jsonData.username + "</h2>" +
          "<p>" + jsonData.message + "</p>" + 
          "</figcaption>" +
          "</figure>";
      }
  }

  Slide = (function() {

    Slide.name = 'Slide';

    function Slide(element, index, options, size) {
      var _this = this;
      this.element = element;
      this.index = index;
      this.options = options;
      this.size = size;
      this.element.css({
        position: 'absolute',
        top: 0,
        left: this.index * this.element.width()
      });

      this.element.children().each(function(index, aelem) {
        $(aelem).children().each(function(index2, imgelem) {
        if(imgelem.width) {
          $(imgelem).css({
            position: 'relative',
            left: (_this.size.width/2 - imgelem.width/2),
            top: (_this.size.height/2 - imgelem.height/2)
          });
        }
        });
      }); 
    }

    return Slide;

  })();

  Slider = (function() {

    Slider.name = 'Slider';

    function Slider(container, options) {
      this.container = container;
      this.options = options;
      this.state = 'waiting';
      this.size = {
        height: this.container.height(),
        width: this.container.width()
      };
      this.container.css({
        overflow: 'hidden',
        position: 'absolute',
        top: 0,
        left: 0
      }).wrap("<div class='" + this.options.containerClass + "' style='position: relative; overflow: hidden;'/>");
      this.wrapper = this.container.parent();
      this.initSlides();
    }

    Slider.prototype.appendNavigation = function() {
      var _this = this;
      this.wrapper.after(this.nextLink()).after(this.previousLink());
      this.nextLink().on('click', function() {
        _this.stopAutoplay();
        _this.next();
        return false;
      });
      return this.previousLink().on('click', function() {
        _this.stopAutoplay();
        _this.previous();
        return false;
      });
    };

    Slider.prototype.appendPagination = function() {
      var _this = this;
      this.wrapper.after(this.pagination());
      return this.pagination().on('click', 'a', function(e) {
        _this.to(($(e.currentTarget)).attr('href').replace('#', '') - 1);
        _this.stopAutoplay();
        return false;
      });
    };

    Slider.prototype.previousLink = function() {
      return this.$previousLink || (this.$previousLink = $('<a />', {
        html: this.options.previousBtnContent,
        "class": this.options.previousBtnClass,
        href: '#'
      }));
    };

    Slider.prototype.nextLink = function() {
      return this.$nextLink || (this.$nextLink = $('<a />', {
        html: this.options.nextBtnContent,
        "class": this.options.nextBtnClass,
        href: '#'
      }));
    };

    Slider.prototype.pagination = function() {
      var index, slide, _i, _len, _ref;
      if (!this.$pagination) {
        this.$pagination = $('<ul />', {
          "class": this.options.paginationClass
        });
        _ref = this.slides;
        for (index = _i = 0, _len = _ref.length; _i < _len; index = ++_i) {
          slide = _ref[index];
          this.$pagination.append("<li><a href='#" + (index + 1) + "'>" + (index + 1) + "</li>");
        }
      }
      return this.$pagination;
    };

    Slider.prototype.currentPaginationElement = function() {
      return this.pagination().find("li:eq(" + this.currentIndex + ")");
    };

    Slider.prototype.count = function() {
      return this.slides.length;
    };

    Slider.prototype.initSlides = function() {
      var _this = this;
      this.slides = [];
      this.container.children().each(function(index, element) {
        return _this.slides.push(new Slide($(element), index, _this.options, _this.size));
      });
      this.container.css('width', this.size.width * this.slides.length);
      return this.initTracker();
    };

    Slider.prototype.currentSlideElement = function() {
      return this.slideElementForIndex(this.currentIndex);
    };

    Slider.prototype.previousSlideElement = function() {
      return this.slideElementForIndex(this.previousIndex);
    };

    Slider.prototype.nextSlideElement = function() {
      return this.slideElementForIndex(this.nextIndex);
    };

    Slider.prototype.slideElementForIndex = function(index) {
      return this.slides[index].element;
    };

    Slider.prototype.updateSlides = function(element, index) {
      var _this = this;
      this.slides.push(new Slide($(element), index, _this.options, _this.size));
      var _ref = this.slides;
      var slide = _ref[index];      
      this.$pagination.append("<li><a href='#" + (index + 1) + "'>" + (index + 1) + "</li>");
      this.container.css('width', this.size.width * this.slides.length);
    };

    Slider.prototype.initTracker = function() {
      this.currentIndex = 0;
      this.previousIndex = this.count() - 1;
      this.nextIndex = 1;
      return this.addCssClasses();
    };

    Slider.prototype.updateTracker = function(newIndex) {
      this.removeCssClasses();
      this.currentIndex = newIndex;
      this.previousIndex = newIndex === 0 ? this.count() - 1 : newIndex - 1;
      this.nextIndex = newIndex === this.count() - 1 ? 0 : newIndex + 1;
      return this.addCssClasses();
    };

    Slider.prototype.addCssClasses = function() {
      this.currentSlideElement().addClass(this.options.currentClass);
      this.previousSlideElement().addClass(this.options.previousClass);
      this.nextSlideElement().addClass(this.options.nextClass);
      return this.currentPaginationElement().addClass(this.options.currentPaginationClass);
    };

    Slider.prototype.removeCssClasses = function() {
      this.currentSlideElement().removeClass(this.options.currentClass);
      this.previousSlideElement().removeClass(this.options.previousClass);
      this.nextSlideElement().removeClass(this.options.nextClass);
      return this.currentPaginationElement().removeClass(this.options.currentPaginationClass);
    };

    Slider.prototype.playing = function() {
      return this.autoplayId != null;
    };

    Slider.prototype.startAutoPlay = function() {
      var _this = this;
      return this.autoplayId = setInterval(function() {
        return _this.next();
      }, this.options.delay);
    };

    Slider.prototype.stopAutoplay = function() {
      if (this.playing()) {
        clearInterval(this.autoplayId);
        return this.autoplayId = null;
      }
    };

    Slider.prototype.play = function() {
      var _this = this;
      this.startAutoPlay();
      if (this.options.pauseOnHover) {
        return this.container.children().on('mouseover', function() {
          return _this.pause();
        }).on('mouseleave', function() {
          return _this.resume();
        });
      }
    };

    Slider.prototype.next = function() {
      return this.to(this.nextIndex);
    };

    Slider.prototype.previous = function() {
      return this.to(this.previousIndex);
    };

    Slider.prototype.callAnimationCallbackFunction = function(functionName, index) {
      return this.options[functionName](this.slideElementForIndex[index], index + 1);
    };

    Slider.prototype.to = function(index) {
      var _this = this;
      if (this.state !== 'animating') {
        this.state = 'animating';
        this.callAnimationCallbackFunction('onTransition', index);
        return this.container.animate({
          left: 0 - (this.size.width * index)
        }, this.options.transitionSpeed, this.options.transitionEasing, function() {
          _this.updateTracker(index);
          _this.state = 'waiting';
          return _this.callAnimationCallbackFunction('onComplete', index);
        });
      }
    };

    Slider.prototype.pause = function() {
      return this.stopAutoplay();
    };

    Slider.prototype.resume = function() {
      return this.startAutoPlay();
    };

    return Slider;

  })();

  $(function() {
    var currentUrl = $(location).attr('href');
    console.log(currentUrl);
    $.ajax({
      url: "/img",
      async: false,
      success: function(data){
        var imgData = data.data;
        for (var index in imgData) {
          console.log(imgData[index].short_id);
          var tag = getFigtag(imgData[index]);
          $("#slider").append(tag);
        }
      }
    });
    $.miniSlider = function(element, options) {
      var slider;
      this.defaults = {
        autoPlay: true,
        delay: 3000,
        containerClass: 'slider-container',
        currentClass: 'current',
        previousClass: 'previous',
        nextClass: 'next',
        transitionSpeed: 500,
        transitionEasing: 'swing',
        pauseOnHover: false,
        showNavigation: true,
        previousBtnClass: 'previousBtn',
        nextBtnClass: 'nextBtn',
        previousBtnContent: '&lsaquo;',
        nextBtnContent: '&rsaquo;',
        showPagination: true,
        paginationClass: 'pagination',
        currentPaginationClass: 'currentPagination',
        onLoad: function(){},
        onReady: function() {},
        onTransition: function() {},
        onComplete: function() {}
      };
      slider = {};
      this.settings = {};
      this.$element = $(element);
      this.getSetting = function(settingKey) {
        return this.settings[settingKey];
      };
      this.callSettingFunction = function(functionName) {
        return this.settings[functionName]();
      };
      var socket = io.connect();
      socket.on('updated', function(data){
        console.log('data :' + data.username);
        var tag = getFigtag(data);
        var sliders = $("#slider").append(tag);
        slider.updateSlides($("figure:last"), sliders.children().length-1);
      });
      var playBtn = $(".play").click(function(){slider.play();});
      var stopBtn = $(".stop").click(function(){slider.pause();});
      console.log(playBtn);
      this.init = function() {
        this.settings = $.extend({}, this.defaults, options);
        this.callSettingFunction('onLoad');
        slider = new Slider(this.$element, this.settings);
        if (this.getSetting('showPagination')) {
          slider.appendPagination();
        }
        if (this.getSetting('showNavigation')) {
          slider.appendNavigation();
        }
        this.callSettingFunction('onReady');
        if (this.getSetting('autoPlay')) {
          return slider.play();
        }
      };
      return this.init();
    };
    return $.fn.miniSlider = function(options) {
      return this.each(function() {
        var plugin;
        if (void 0 === $(this).data('miniSlider')) {
          plugin = new $.miniSlider(this, options);
          return $(this).data('miniSlider', plugin);
        }
      });
    };
  });

}).call(this);
